#!/bin/bash

set -e

DEPLOYMENT="messaging-app-blue"
SERVICE_HOST="localhost"
SERVICE_PORT="8000"
ENDPOINT="http://$SERVICE_HOST:$SERVICE_PORT/"

echo "ğŸš€ Applying updated blue_deployment.yaml (image version 2.0)..."
kubectl apply -f blue_deployment.yaml

echo "ğŸ”„ Triggering rolling update..."
kubectl rollout status deployment/$DEPLOYMENT

echo "ğŸŒ Starting continuous curl test to detect downtime..."
echo "Press CTRL + C to stop."

for i in {1..20}
do
  RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $ENDPOINT)
  echo "Request $i â†’ Status: $RESPONSE"
  sleep 1
done

echo "ğŸ“Œ Checking current running pods..."
kubectl get pods -l app=messaging-app -o wide

echo "ğŸ‰ Rolling update completed successfully!"
