#!/bin/bash

# Script to scale the Django app deployment to 3 replicas,
# verify pods, run load testing using wrk,
# and monitor resource usage.

set -e

DEPLOYMENT_NAME="messaging-app-deployment"

echo "Checking if kubernetes is running..."

kubectl cluster-info > /dev/null 2>&1 || {
    echo "Kubernetes cluster is not running. Please start your cluster first."
    exit 1
}

echo "Scaling the Django app deployment to 3 replicas..."
kubectl scale deployment/$DEPLOYMENT_NAME --replicas=3

sleep 5

echo "Verifying the number of pods for the deployment..."
kubectl get pods -o wide

echo "Checking if wrk is installed..."
if ! command -v wrk &> /dev/null
then
    echo "wrk could not be found, please install it first."
    exit 1
fi


echo "Starting wrk load test (10 seconds)..."
echo "Note: Make sure you port-forward the Django app service to localhost:8000 before running this script."

sleep 2

wrk -t2 -c100 -d10s http://localhost:8000/

echo "Monitoring resource usage of the pods..."
echo "Requires metrics-server. If missing, install it in your cluster."
kubectl top pods || echo "Metrics server not available. Skipping resource usage monitoring."

echo "Done! Load testing and monitoring completed."
